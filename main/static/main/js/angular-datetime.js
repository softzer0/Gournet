angular.module("datetime",[]),angular.module("datetime").factory("datetime",["$locale",function(e){function t(e){var t,n=[];for(t=1;t<e.length;t++)n.push(e[t]);return n.push(e[0]),n}function n(e){return D[e]||e}function a(e,t){return{token:M[e],value:t,viewValue:t||"",offset:0,next:null,prev:null,id:null}}function r(e){for(var t,n=[],r=0;t=L.exec(e);)t.index>r&&(n.push(a("string",e.substring(r,t.index))),r=t.index),t.index==r&&(t[1]?(n.push(a("string",t[1])),n.push(a("sss"))):n.push(t[2]?a("string",t[2].replace("''","'")):a(t[0])),r=L.lastIndex);r<e.length&&n.push(a("string",e.substring(r)));var o;for(o=0;o<n.length;o++)n[o].next=n[o+1]||null,n[o].prev=n[o-1]||null,n[o].id=o;return n}function o(e,t){e=e.substring(t);var n=e.match(/^\d+/);return n&&n[0]}function s(e,t,n){for(var a=0,r=e.toUpperCase(),o=n.toUpperCase();r[t+a]&&r[t+a]==o[a];)a++;return e.substr(t,a)}function i(e){var t=new Date(e.getFullYear(),0,1),n=new Date(t.getTime());n.setDate(n.getDay()>4?n.getDate()+(1-n.getDay())+7:n.getDate()+(1-n.getDay()));var a=e.getTime()-n.getTime();return Math.floor(a/6048e5)}function u(e,t,n){var a;if(e=""+e,e.length>n)e=e.substr(e.length-n);else if(e.length<t)for(a=e.length;t>a;a++)e="0"+e;return e}function m(e){return":"==e[3]?e:e.substr(0,3)+":"+e.substr(3,2)}function d(e){return":"!=e[3]?e:e.substr(0,3)+e.substr(4,2)}function l(e,t,n,a){switch(n.name){case"year":e.value=t.getFullYear(),e.value<0&&(e.value=0);break;case"month":e.value=t.getMonth()+1;break;case"date":e.value=t.getDate();break;case"day":e.value=t.getDay()||7;break;case"hour":e.value=t.getHours();break;case"hour12":e.value=t.getHours()%12||12;break;case"ampm":e.value=t.getHours()<12?1:2;break;case"minute":e.value=t.getMinutes();break;case"second":e.value=t.getSeconds();break;case"millisecond":e.value=t.getMilliseconds();break;case"week":e.value=i(t);break;case"timezone":e.value=d(a||$);break;case"timezoneWithColon":e.value=m(a||$)}switch(n.type){case"number":e.viewValue=u(e.value,n.minLength,n.maxLength);break;case"select":e.viewValue=n.select[e.value-1];break;default:e.viewValue=e.value+""}}function c(e,t){var n=e.getMonth(),a=t-(e.getDay()||7);e.setDate(e.getDate()+a),e.getMonth()!=n&&e.setDate(a>0?e.getDate()-7:e.getDate()+7)}function g(e,t){t%=12,e.getHours()<12||(t+=12),e.setHours(t)}function h(e,t){var n=e.getHours();12>n==t>1&&e.setHours((n+12)%24)}function f(e,t,n){switch(n.name){case"year":e.setFullYear(t);break;case"month":e.setMonth(t-1),e.getMonth()==t&&e.setDate(0);break;case"date":e.setDate(t);break;case"day":c(e,t);break;case"hour":e.setHours(t);break;case"hour12":g(e,t);break;case"ampm":h(e,t);break;case"minute":e.setMinutes(t);break;case"second":e.setSeconds(t);break;case"millisecond":e.setMilliseconds(t);break;case"week":e.setDate(e.getDate()+7*(t-i(e)))}e.getFullYear()<0&&e.setFullYear(0)}function v(e){var t,n=0;for(t=0;t<e.length;t++)e[t].offset=n,n+=e[t].viewValue.length}function p(e,t,n){var a,r,i,m,d=e;switch(d.token.type){case"static":if(t.lastIndexOf(d.value,n)!=n)throw{code:"TEXT_MISMATCH",message:"Pattern value mismatch",text:t,node:d,pos:n};break;case"number":if(i=o(t,n),null==i)throw{code:"NUMBER_MISMATCH",message:"Invalid number",text:t,node:d,pos:n};if(i.length<d.token.minLength)throw{code:"NUMBER_TOOSHORT",message:"The length of number is too short",text:t,node:d,pos:n,match:i,properValue:u(+i,d.token.minLength,d.token.maxLength)};if(i.length>d.token.maxLength&&(i=i.substr(0,d.token.maxLength)),+i<d.token.min)throw{code:"NUMBER_TOOSMALL",message:"The number is too small",text:t,node:d,pos:n,match:i};if(i.length>d.token.minLength&&"0"==i[0])throw{code:"LEADING_ZERO",message:"The number has too many leading zero",text:t,node:d,pos:n,match:i,properValue:u(+i,d.token.minLength,d.token.maxLength)};d.value=+i,d.viewValue=i;break;case"select":for(r="",m=0;m<d.token.select.length;m++)a=s(t,n,d.token.select[m]),a&&a.length>r.length&&(i=m,r=a);if(!r)throw{code:"SELECT_MISMATCH",message:"Invalid select",text:t,node:d,pos:n};if(r!=d.token.select[i])throw{code:"SELECT_INCOMPLETE",message:"Incomplete select",text:t,node:d,pos:n,match:r,selected:d.token.select[i]};d.value=i+1,d.viewValue=r;break;case"regex":if(a=e.token.regex.exec(t.substr(n)),!a||0!=a.index)throw{code:"REGEX_MISMATCH",message:"Regex doesn't match",text:t,node:d,pos:n};d.value=a[0],d.viewValue=a[0]}}function x(e,t,n){var a;switch(t.name){case"year":e.setFullYear(e.getFullYear()+n);break;case"month":a=e.getMonth()+n,e.setMonth(a),e.getMonth()==a+1&&e.setDate(0);break;case"date":case"day":e.setDate(e.getDate()+n);break;case"hour":case"hour12":e.setHours(e.getHours()+n);break;case"ampm":e.setHours(e.getHours()+12*n);break;case"minute":e.setMinutes(e.getMinutes()+n);break;case"second":e.setSeconds(e.getSeconds()+n);break;case"millisecond":e.setMilliseconds(e.getMilliseconds()+n);break;case"week":e.setDate(e.getDate()+7*n)}}function k(e,t,n){var a,r,o,s,i;for(r=0,a=0;a<e.length;a++){s=e[a].viewValue;try{p(e[a],t,r)}catch(u){if("NUMBER_TOOSHORT"==u.code||"NUMBER_TOOSMALL"==u.code||"LEADING_ZERO"==u.code){o=u,r+=u.match.length;continue}throw u}r+=e[a].viewValue.length,s!=e[a].viewValue&&("date"==e[a].token.name?i=e[a]:f(n,e[a].value,e[a].token))}if(t.length>r)throw{code:"TEXT_TOOLONG",message:"Text is too long",text:t,pos:r};if(o)throw o;i&&f(n,i.value,i.token)}function y(e,t){t=d(t);var n=+t.substr(1,2),a=+t.substr(3,2),r=t[0]+"1",o=(60*n+a)*r;return new Date(e.getTime()+60*(-e.getTimezoneOffset()-o)*1e3)}function b(e,t){t=d(t);var n=+t.substr(1,2),a=+t.substr(3,2),r=t[0]+"1",o=(60*n+a)*r;return new Date(e.getTime()+60*(o- -e.getTimezoneOffset())*1e3)}function w(e,t,n){var a,r;for(a=0;a<e.length;a++)r=e[a],l(r,t,r.token,n);v(e)}function T(e){e=n(e);for(var t=r(e),a={parse:function(e){var t,n=a.date,r=new Date(n.getTime()),o=a.getText();if(!e)throw{code:"EMPTY",message:"The input is empty",oldText:o};try{if(k(a.nodes,e,r),w(a.nodes,r,a.timezoneNode&&a.timezoneNode.viewValue),t=a.getText(),e!=t)throw{code:"INCONSISTENT_INPUT",message:"Successfully parsed but the output text doesn't match the input",text:e,oldText:o,properText:t}}catch(s){throw w(a.nodes,n,a.timezone),s}return a.timezoneNode&&a.setTimezone(a.timezoneNode.viewValue),a.date=r,a.model=a.timezone?y(r,a.timezone):new Date(r.getTime()),a},nodeParseValue:function(e,t){var n=a.date,r=e.value,o=e.viewValue;try{p(e,t,0),v(a.nodes)}catch(s){throw e.value=r,e.viewValue=o,s}return f(n,e.value,e.token),w(a.nodes,n,a.timezone),a.model=a.timezone?y(n,a.timezone):new Date(n.getTime()),a},nodeAddValue:function(e,t){var n=a.date;return x(n,e.token,t),w(a.nodes,n,a.timezone),a.model=a.timezone?y(n,a.timezone):new Date(n.getTime()),a},setDate:function(e){return a.model=new Date(e.getTime()),a.date=a.timezone?b(e,a.timezone):new Date(e.getTime()),w(a.nodes,a.date,a.timezone),a},getDate:function(){return a.model},getText:function(e){e&&w(a.nodes,b(a.model,e),e);var t,n="";for(t=0;t<a.nodes.length;t++)n+=a.nodes[t].viewValue;return n},setTimezone:function(e){e||(e=$),e!=a.timezone&&(a.timezone=e,a.date=b(a.model,e),w(a.nodes,a.date,e))},date:null,model:null,format:e,nodes:t,timezone:null,timezoneNode:null},o=a.nodes[0];o;){if("timezone"==o.token.name||"timezoneWithColon"==o.token.name){a.timezoneNode=o;break}o=o.next}return a.setDate(new Date),a}var D=e.DATETIME_FORMATS,L=/yyyy|yy|y|M{1,4}|dd?|EEEE?|HH?|hh?|mm?|ss?|([.,])sss|a|Z{1,2}|ww|w|'(([^']+|'')*)'/g,M={y:{minLength:1,maxLength:4,min:1,max:9999,name:"year",type:"number"},yy:{minLength:2,maxLength:2,min:1,max:99,name:"year",type:"number"},yyyy:{minLength:4,maxLength:4,min:1,max:9999,name:"year",type:"number"},MMMM:{name:"month",type:"select",select:D.MONTH},MMM:{name:"month",type:"select",select:D.SHORTMONTH},MM:{minLength:2,maxLength:2,min:1,max:12,name:"month",type:"number"},M:{minLength:1,maxLength:2,min:1,max:12,name:"month",type:"number"},dd:{minLength:2,maxLength:2,min:1,max:31,name:"date",type:"number"},d:{minLength:1,maxLength:2,min:1,max:31,name:"date",type:"number"},EEEE:{name:"day",type:"select",select:t(D.DAY)},EEE:{name:"day",type:"select",select:t(D.SHORTDAY)},HH:{minLength:2,maxLength:2,min:0,max:23,name:"hour",type:"number"},H:{minLength:1,maxLength:2,min:0,max:23,name:"hour",type:"number"},hh:{minLength:2,maxLength:2,min:1,max:12,name:"hour12",type:"number"},h:{minLength:1,maxLength:2,min:1,max:12,name:"hour12",type:"number"},mm:{minLength:2,maxLength:2,min:0,max:59,name:"minute",type:"number"},m:{minLength:1,maxLength:2,min:0,max:59,name:"minute",type:"number"},ss:{minLength:2,maxLength:2,min:0,max:59,name:"second",type:"number"},s:{minLength:1,maxLength:2,min:0,max:59,name:"second",type:"number"},sss:{minLength:3,maxLength:3,min:0,max:999,name:"millisecond",type:"number"},a:{name:"ampm",type:"select",select:D.AMPMS},ww:{minLength:2,maxLength:2,min:0,max:53,name:"week",type:"number"},w:{minLength:1,maxLength:2,min:0,max:53,name:"week",type:"number"},Z:{name:"timezone",type:"regex",regex:/[+-]\d{4}/},ZZ:{name:"timezoneWithColon",type:"regex",regex:/[+-]\d{2}:\d{2}/},string:{name:"string",type:"static"}},$=function(){var e=-(new Date).getTimezoneOffset(),t=0>e?"-":"+",n=Math.abs(e),a=Math.floor(n/60),r=n%60;return t+u(a,2,2)+u(r,2,2)}();return T}]),angular.module("datetime").directive("datetime",["datetime","$log","$document",function(e,t,n){function a(e){var t=k.selection.createRange().getBookmark(),n=e.createTextRange(),a=n.duplicate();n.moveToBookmark(t),a.setEndPoint("EndToStart",n);var r=a.text.length,o=r+n.text.length;return{start:r,end:o}}function r(e){return e=e[0],void 0!=e.selectionStart&&void 0!=e.selectionEnd?{start:e.selectionStart,end:e.selectionEnd}:k.selection?a(e):void 0}function o(e){return u(e[0])}function s(e,t){var n=e.createTextRange();n.moveStart("character",t.start),n.collapse(),n.moveEnd("character",t.end-t.start),n.select()}function i(e,t){e=e[0],e.setSelectionRange?e.setSelectionRange(t.start,t.end):e.createTextRange&&s(e,t)}function u(e,t){for(t||(t="next");e&&("static"==e.token.type||"regex"==e.token.type);)e=e[t];return e}function m(e,t){var n;do n=e,e=u(e[t],t);while(e);return n}function d(e,t,n){e.node&&(t&&(e.start=0,e.end="end",e.node=n?m(e.node,t):u(e.node[t],t)||e.node),i(e.element,{start:e.start+e.node.offset,end:"end"==e.end?e.node.offset+e.node.viewValue.length:e.end+e.node.offset}))}function l(e){return"static"==e.token.type||"regex"==e.token.type}function c(e,t,n){var a=e.node.offset+e.start,r=t.offset-a,o=a-(n.offset+n.viewValue.length);return r>o?n:t}function g(e,t){var n,a,r;return r=h(e,t),l(r.node)&&(a=u(r.node,"next"),n=u(r.node,"prev"),a||n?r.node=a&&n?c(r,a,n):a||n:(r.node=t[0],r.end=0)),r.start=0,r.end="end",r}function h(e,t,n){var a,o,s=r(e);for(a=0;a<t.length;a++)if(!o&&t[a].offset+t[a].viewValue.length>=s.start||a==t.length-1){o={element:e,node:t[a],start:s.start-t[a].offset,end:s.start-t[a].offset};break}return n&&o.node.next==n&&o.start+o.node.offset==o.node.next.offset&&(o.node=o.node.next,o.start=o.end=0),o}function f(e){return e.start==e.end||e.start==e.node.viewValue.length&&"end"==e.end}function v(e){var t,n;return f(e)?(t=e.node.token.maxLength,n=e.node.viewValue.length,t&&t>n?!1:e.start==n):!1}function p(e){var t=e.charCode||e.keyCode;return t>=48&&57>=t||t>=65&&90>=t||t>=97&&122>=t}function x(n,a,r,s){function i(){s.$setViewValue(y.getText()),s.$render()}function m(e){e&&!x?(x=!0,y.setTimezone("+0000"),b&&b.setTimezone("+0000"),n.$evalAsync(i)):!e&&x&&(x=!1,y.setTimezone(null),b&&b.setTimezone(null),n.$evalAsync(i))}function l(e){return s.$validate?s.$validate():(s.$setValidity("min",D(e)),s.$setValidity("max",L(e))),!s.$error.min&&!s.$error.max}function c(){f.properValue&&(y.nodeParseValue(f.node,f.properValue),s.$setViewValue(y.getText()),s.$render(),n.$apply())}var f,x,y=e(r.datetime),b=r.datetimeModel&&e(r.datetimeModel),w={element:a,node:o(y.nodes),start:0,end:"end"},T={element:a,node:null,start:0,end:0};angular.isDefined(r.datetimeUtc)&&(r.datetimeUtc.length>0?n.$watch(r.datetimeUtc,m):m(!0));var D=function(e){return s.$isEmpty(e)||s.$isEmpty(r.min)?!0:(angular.isDate(e)||(e=b.getDate()),e>=new Date(r.min))},L=function(e){return s.$isEmpty(e)||s.$isEmpty(r.max)?!0:(angular.isDate(e)||(e=b.getDate()),e<=new Date(r.max))};s.$validators&&(s.$validators.min=D,s.$validators.max=L),r.$observe("min",function(){l(y.getDate())}),r.$observe("max",function(){l(y.getDate())}),s.$render=function(){a.val(s.$viewValue||""),k.activeElement==a[0]&&d(w)},s.$parsers.push(function(e){if(!e&&angular.isUndefined(r.required))return w.node=o(y.nodes),w.start=0,w.end="end",s.$setValidity("datetime",!0),null;try{y.parse(e)}catch(a){return f=a,t.error(a),s.$setValidity("datetime",!1),void("NUMBER_TOOSHORT"==a.code||"NUMBER_TOOSMALL"==a.code&&a.match.length<a.node.token.maxLength?(T.node=a.node,T.start=0,T.end=a.match.length):("LEADING_ZERO"==a.code?(e=e.substr(0,a.pos)+a.properValue+e.substr(a.pos+a.match.length),a.match.length<a.node.token.maxLength?(w.start+=a.properValue.length-a.match.length+1,w.end=w.start):d(w,"next")):"SELECT_INCOMPLETE"==a.code?(y.nodeParseValue(w.node,a.selected),e=y.getText(),w.start=a.match.length,w.end="end"):"INCONSISTENT_INPUT"==a.code?(e=a.properText,w.start++,w.end=w.start):(e=y.getText(),w.start=0,w.end="end"),n.$evalAsync(function(){if(e==s.$viewValue)throw"angular-datetime crashed!";s.$setViewValue(e),s.$render()})))}if(f=null,s.$setValidity("datetime",!0),s.$validate||l(y.getDate())){var i=y.getDate();return b?b.setDate(i).getText():new Date(i.getTime())}return void 0}),s.$formatters.push(function(e){return e?(s.$setValidity("datetime",!0),b&&(e=b.parse(e).getDate()),y.setDate(e).getText()):(s.$setValidity("datetime",angular.isUndefined(r.required)),"")});var M;a.on("focus keydown keypress mousedown click",function(e){switch(e.type){case"mousedown":M=!0;break;case"focus":e.preventDefault(),s.$viewValue||(angular.isDefined(r["default"])&&y.setDate(new Date(r["default"])),s.$setViewValue(y.getText()),s.$render(),n.$apply()),M||setTimeout(function(){d(s.$error.datetime?T:w)});break;case"keydown":switch(e.keyCode){case 37:e.preventDefault(),f&&c(),s.$error.datetime?d(T):d(w,"prev");break;case 39:e.preventDefault(),f&&c(),s.$error.datetime?d(T):d(w,"next");break;case 38:e.preventDefault(),y.nodeAddValue(w.node,1),s.$setViewValue(y.getText()),w.start=0,w.end="end",s.$render(),n.$apply();break;case 40:e.preventDefault(),y.nodeAddValue(w.node,-1),s.$setViewValue(y.getText()),w.start=0,w.end="end",s.$render(),n.$apply();break;case 36:e.preventDefault(),s.$error.datetime?d(T):d(w,"prev",!0);break;case 35:e.preventDefault(),s.$error.datetime?d(T):d(w,"next",!0)}break;case"click":e.preventDefault(),M=!1,s.$error.datetime?d(T):(w=g(a,y.nodes),d(w));break;case"keypress":var t=r.datetimeSeparator||"",o=String.fromCharCode(e.keyCode||e.which);w.node.next&&"static"===w.node.next.token.type&&(t+=w.node.next.viewValue[0]),t.indexOf(o)<0?p(e)&&setTimeout(function(){w=h(a,y.nodes,w.node),v(w)&&(w.node=u(w.node.next)||w.node,w.start=0,w.end="end",d(w))}):(e.preventDefault(),f&&c(),s.$error.datetime?d(T):d(w,"next"))}})}var k=n[0];return{restrict:"A",require:"?ngModel",link:x}}]);